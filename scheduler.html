---
layout: null
permalink: /scheduler
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Optimiser (Prototype)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18",
        "react-dom/client": "https://esm.sh/react-dom@18/client",
        "lucide-react": "https://esm.sh/lucide-react@0.454.0?external=react"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
import * as React from 'react';
import { createRoot } from 'react-dom/client';
import { Plus, Trash2, Calendar, Users, Grid3X3, Zap, Star, Clock, Pencil, Check, X, Save, Upload } from 'lucide-react';

const { useState } = React;
const h = React.createElement;

const StarRating = ({ value, onChange }) => {
  return h('div', { className: 'flex gap-0.5' },
    [1, 2, 3, 4, 5].map((star) =>
      h('button', {
        key: star,
        onClick: () => onChange(value === star ? 0 : star),
        className: 'p-0.5 hover:scale-110 transition-transform'
      },
        h(Star, {
          size: 18,
          className: star <= value ? 'fill-amber-400 text-amber-400' : 'text-gray-300'
        })
      )
    )
  );
};

const optimize = (shifts, participants, preferences) => {
  if (shifts.length === 0 || participants.length === 0) return null;

  let bestAssignment = null;
  let bestScore = -Infinity;

  const search = (shiftIdx, assignment, score, paTotals) => {
    if (shiftIdx === shifts.length) {
      const quotasMet = participants.every(p => paTotals[p.id] >= (p.paQuota || 0));
      if (quotasMet && score > bestScore) {
        bestScore = score;
        bestAssignment = { ...assignment };
      }
      return;
    }

    const shift = shifts[shiftIdx];
    const shiftPa = shift.pa || 0;

    for (const p of participants) {
      const pref = preferences[p.id]?.[shift.id] ?? 0;
      if (pref === 0) continue;

      assignment[shift.id] = p.id;
      paTotals[p.id] = (paTotals[p.id] || 0) + shiftPa;
      search(shiftIdx + 1, assignment, score + pref, paTotals);
      paTotals[p.id] -= shiftPa;
    }

    delete assignment[shift.id];
  };

  const initialPa = {};
  participants.forEach(p => initialPa[p.id] = 0);
  search(0, {}, 0, initialPa);

  if (!bestAssignment) {
    let relaxedBest = null;
    let relaxedScore = -Infinity;

    const relaxedSearch = (shiftIdx, assignment, score, paTotals) => {
      if (shiftIdx === shifts.length) {
        if (score > relaxedScore) {
          relaxedScore = score;
          relaxedBest = { assignment: { ...assignment }, paTotals: { ...paTotals } };
        }
        return;
      }

      const shift = shifts[shiftIdx];
      const shiftPa = shift.pa || 0;

      for (const p of participants) {
        const pref = preferences[p.id]?.[shift.id] ?? 0;
        if (pref === 0) continue;

        assignment[shift.id] = p.id;
        paTotals[p.id] = (paTotals[p.id] || 0) + shiftPa;
        relaxedSearch(shiftIdx + 1, assignment, score + pref, paTotals);
        paTotals[p.id] -= shiftPa;
      }

      delete assignment[shift.id];
    };

    relaxedSearch(0, {}, 0, initialPa);

    if (relaxedBest) {
      return { assignment: relaxedBest.assignment, score: relaxedScore, paTotals: relaxedBest.paTotals, quotasNotMet: true };
    }
    return null;
  }

  const finalPa = {};
  participants.forEach(p => finalPa[p.id] = 0);
  Object.entries(bestAssignment).forEach(([shiftId, personId]) => {
    const shift = shifts.find(s => s.id === shiftId);
    finalPa[personId] += shift?.pa || 0;
  });

  return { assignment: bestAssignment, score: bestScore, paTotals: finalPa, quotasNotMet: false };
};

function ShiftOptimizer() {
  const [tab, setTab] = useState('shifts');
  const [shifts, setShifts] = useState([]);
  const [participants, setParticipants] = useState([]);
  const [preferences, setPreferences] = useState({});
  const [newShift, setNewShift] = useState({ name: '', date: '', time: '', pa: '' });
  const [newParticipant, setNewParticipant] = useState({ name: '', paQuota: '' });
  const [result, setResult] = useState(null);
  const [editingShift, setEditingShift] = useState(null);
  const [editingParticipant, setEditingParticipant] = useState(null);

  const addShift = () => {
    if (!newShift.name || !newShift.date) return;
    setShifts([...shifts, { id: Date.now().toString(), ...newShift, pa: parseFloat(newShift.pa) || 0 }]);
    setNewShift({ name: '', date: '', time: '', pa: '' });
  };

  const addParticipant = () => {
    if (!newParticipant.name.trim()) return;
    const id = Date.now().toString();
    setParticipants([...participants, { id, name: newParticipant.name.trim(), paQuota: parseFloat(newParticipant.paQuota) || 0 }]);
    setPreferences({ ...preferences, [id]: {} });
    setNewParticipant({ name: '', paQuota: '' });
  };

  const startEditShift = (shift) => {
    setEditingShift({ ...shift, pa: shift.pa.toString() });
  };

  const saveEditShift = () => {
    if (!editingShift.name || !editingShift.date) return;
    setShifts(shifts.map(s => s.id === editingShift.id
      ? { ...editingShift, pa: parseFloat(editingShift.pa) || 0 }
      : s
    ));
    setEditingShift(null);
  };

  const startEditParticipant = (participant) => {
    setEditingParticipant({ ...participant, paQuota: participant.paQuota.toString() });
  };

  const saveEditParticipant = () => {
    if (!editingParticipant.name.trim()) return;
    setParticipants(participants.map(p => p.id === editingParticipant.id
      ? { ...editingParticipant, name: editingParticipant.name.trim(), paQuota: parseFloat(editingParticipant.paQuota) || 0 }
      : p
    ));
    setEditingParticipant(null);
  };

  const updatePref = (pId, sId, value) => {
    setPreferences({
      ...preferences,
      [pId]: { ...preferences[pId], [sId]: value }
    });
  };

  const runOptimizer = () => {
    const res = optimize(shifts, participants, preferences);
    setResult(res);
    setTab('results');
  };

  const tabs = [
    { id: 'shifts', label: 'Shifts', icon: Calendar },
    { id: 'participants', label: 'People', icon: Users },
    { id: 'preferences', label: 'Preferences', icon: Grid3X3 },
    { id: 'results', label: 'Results', icon: Zap },
  ];

  const saveToFile = () => {
    const filename = prompt('Enter filename:', 'schedule');
    if (!filename) return;
    const data = {
      version: 1,
      shifts,
      participants,
      preferences
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename.endsWith('.schdl') ? filename : `${filename}.schdl`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const loadFromFile = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.schdl';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (data.shifts) setShifts(data.shifts);
          if (data.participants) setParticipants(data.participants);
          if (data.preferences) setPreferences(data.preferences);
          setResult(null);
        } catch (err) {
          alert('Failed to load schedule file. Please check the file format.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const loadExample = () => {
    const exShifts = [
      { id: '1', name: 'Monday AM', date: '2025-01-13', time: '08:00', pa: 1 },
      { id: '2', name: 'Monday PM', date: '2025-01-13', time: '14:00', pa: 1 },
      { id: '3', name: 'Tuesday AM', date: '2025-01-14', time: '08:00', pa: 1.5 },
      { id: '4', name: 'Tuesday PM', date: '2025-01-14', time: '14:00', pa: 1 },
      { id: '5', name: 'Wednesday AM', date: '2025-01-15', time: '08:00', pa: 0.5 },
    ];
    const exPeople = [
      { id: 'a', name: 'Dr Smith', paQuota: 2 },
      { id: 'b', name: 'Dr Jones', paQuota: 1.5 },
      { id: 'c', name: 'Dr Patel', paQuota: 1.5 },
    ];
    const exPrefs = {
      'a': { '1': 5, '2': 3, '3': 0, '4': 4, '5': 2 },
      'b': { '1': 2, '2': 5, '3': 4, '4': 0, '5': 5 },
      'c': { '1': 3, '2': 4, '3': 5, '4': 3, '5': 1 },
    };
    setShifts(exShifts);
    setParticipants(exPeople);
    setPreferences(exPrefs);
    setResult(null);
  };

  return h('div', { className: 'min-h-screen bg-slate-50 p-6' },
    h('div', { className: 'max-w-4xl mx-auto' },
      // Header
      h('div', { className: 'flex flex-wrap items-center justify-between gap-3 mb-6' },
        h('h1', { className: 'text-2xl font-bold text-slate-800' }, "Shift Optimiser (Prototype)"),
        h('div', { className: 'flex flex-wrap gap-2' },
          h('button', {
            onClick: saveToFile,
            className: 'px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm font-medium flex items-center gap-2'
          }, h(Save, { size: 16 }), 'Save'),
          h('button', {
            onClick: loadFromFile,
            className: 'px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center gap-2'
          }, h(Upload, { size: 16 }), 'Load'),
          h('button', {
            onClick: loadExample,
            className: 'px-3 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 text-sm font-medium'
          }, 'Example')
        )
      ),

      // Tabs
      h('div', { className: 'flex flex-wrap gap-2 mb-6' },
        tabs.map(({ id, label, icon: Icon }) =>
          h('button', {
            key: id,
            onClick: () => setTab(id),
            className: `flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-colors text-sm sm:text-base sm:px-4 ${
              tab === id ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 hover:bg-slate-100'
            }`
          },
            h(Icon, { size: 18 }),
            label
          )
        )
      ),

      // Content
      h('div', { className: 'bg-white rounded-xl shadow-sm p-6' },
        // Shifts Tab
        tab === 'shifts' && h('div', null,
          h('h2', { className: 'text-lg font-semibold mb-4' }, 'Manage Shifts'),
          h('div', { className: 'flex flex-wrap gap-3 mb-4' },
            h('input', {
              type: 'text',
              placeholder: 'Shift name',
              value: newShift.name,
              onChange: (e) => setNewShift({ ...newShift, name: e.target.value }),
              className: 'flex-1 min-w-[120px] px-3 py-2 border rounded-lg'
            }),
            h('div', { className: 'relative flex items-center' },
              h(Calendar, { size: 16, className: 'absolute left-3 text-slate-400 pointer-events-none' }),
              h('input', {
                type: 'date',
                value: newShift.date,
                onChange: (e) => setNewShift({ ...newShift, date: e.target.value }),
                className: 'pl-9 pr-3 py-2 border rounded-lg'
              })
            ),
            h('div', { className: 'relative flex items-center' },
              h(Clock, { size: 16, className: 'absolute left-3 text-slate-400 pointer-events-none' }),
              h('input', {
                type: 'time',
                value: newShift.time,
                onChange: (e) => setNewShift({ ...newShift, time: e.target.value }),
                className: 'pl-9 pr-3 py-2 border rounded-lg'
              })
            ),
            h('input', {
              type: 'number',
              step: '0.5',
              placeholder: 'PA',
              value: newShift.pa,
              onChange: (e) => setNewShift({ ...newShift, pa: e.target.value }),
              className: 'w-20 px-3 py-2 border rounded-lg'
            }),
            h('button', {
              onClick: addShift,
              className: 'px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2 whitespace-nowrap'
            }, h(Plus, { size: 18 }), ' Add')
          ),
          shifts.length === 0
            ? h('p', { className: 'text-slate-500 text-center py-8' }, 'No shifts added yet')
            : h('div', { className: 'space-y-2' },
                shifts.map((s) =>
                  editingShift?.id === s.id
                    ? h('div', { key: s.id, className: 'flex flex-wrap items-center gap-2 p-3 bg-indigo-50 rounded-lg' },
                        h('input', {
                          type: 'text',
                          value: editingShift.name,
                          onChange: (e) => setEditingShift({ ...editingShift, name: e.target.value }),
                          className: 'flex-1 min-w-[100px] px-2 py-1 border rounded'
                        }),
                        h('input', {
                          type: 'date',
                          value: editingShift.date,
                          onChange: (e) => setEditingShift({ ...editingShift, date: e.target.value }),
                          className: 'px-2 py-1 border rounded'
                        }),
                        h('input', {
                          type: 'time',
                          value: editingShift.time || '',
                          onChange: (e) => setEditingShift({ ...editingShift, time: e.target.value }),
                          className: 'px-2 py-1 border rounded'
                        }),
                        h('input', {
                          type: 'number',
                          step: '0.5',
                          value: editingShift.pa,
                          onChange: (e) => setEditingShift({ ...editingShift, pa: e.target.value }),
                          className: 'w-16 px-2 py-1 border rounded'
                        }),
                        h('button', {
                          onClick: saveEditShift,
                          className: 'p-2 text-emerald-600 hover:bg-emerald-50 rounded'
                        }, h(Check, { size: 18 })),
                        h('button', {
                          onClick: () => setEditingShift(null),
                          className: 'p-2 text-slate-500 hover:bg-slate-100 rounded'
                        }, h(X, { size: 18 }))
                      )
                    : h('div', { key: s.id, className: 'flex items-center justify-between gap-2 p-3 bg-slate-50 rounded-lg' },
                        h('div', { className: 'flex flex-wrap items-center gap-2 sm:gap-4 min-w-0' },
                          h('div', { className: 'min-w-0' },
                            h('span', { className: 'font-medium' }, s.name),
                            h('span', { className: 'text-slate-500 ml-2 sm:ml-3 text-sm sm:text-base' }, s.date, s.time && ` at ${s.time}`)
                          ),
                          h('span', { className: 'px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-medium whitespace-nowrap' }, s.pa, ' PA')
                        ),
                        h('div', { className: 'flex items-center gap-1 flex-shrink-0' },
                          h('button', {
                            onClick: () => startEditShift(s),
                            className: 'p-2 text-indigo-500 hover:bg-indigo-50 rounded'
                          }, h(Pencil, { size: 18 })),
                          h('button', {
                            onClick: () => setShifts(shifts.filter((x) => x.id !== s.id)),
                            className: 'p-2 text-red-500 hover:bg-red-50 rounded'
                          }, h(Trash2, { size: 18 }))
                        )
                      )
                )
              )
        ),

        // Participants Tab
        tab === 'participants' && h('div', null,
          h('h2', { className: 'text-lg font-semibold mb-4' }, 'Manage Participants'),
          h('div', { className: 'flex flex-wrap gap-3 mb-4' },
            h('input', {
              type: 'text',
              placeholder: 'Name',
              value: newParticipant.name,
              onChange: (e) => setNewParticipant({ ...newParticipant, name: e.target.value }),
              onKeyDown: (e) => e.key === 'Enter' && addParticipant(),
              className: 'flex-1 min-w-[120px] px-3 py-2 border rounded-lg'
            }),
            h('input', {
              type: 'number',
              step: '0.5',
              placeholder: 'PA Quota',
              value: newParticipant.paQuota,
              onChange: (e) => setNewParticipant({ ...newParticipant, paQuota: e.target.value }),
              onKeyDown: (e) => e.key === 'Enter' && addParticipant(),
              className: 'w-28 px-3 py-2 border rounded-lg'
            }),
            h('button', {
              onClick: addParticipant,
              className: 'px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2 whitespace-nowrap'
            }, h(Plus, { size: 18 }), ' Add')
          ),
          participants.length === 0
            ? h('p', { className: 'text-slate-500 text-center py-8' }, 'No participants added yet')
            : h('div', { className: 'space-y-2' },
                participants.map((p) =>
                  editingParticipant?.id === p.id
                    ? h('div', { key: p.id, className: 'flex flex-wrap items-center gap-2 p-3 bg-emerald-50 rounded-lg' },
                        h('input', {
                          type: 'text',
                          value: editingParticipant.name,
                          onChange: (e) => setEditingParticipant({ ...editingParticipant, name: e.target.value }),
                          className: 'flex-1 min-w-[120px] px-2 py-1 border rounded'
                        }),
                        h('input', {
                          type: 'number',
                          step: '0.5',
                          value: editingParticipant.paQuota,
                          onChange: (e) => setEditingParticipant({ ...editingParticipant, paQuota: e.target.value }),
                          placeholder: 'PA Quota',
                          className: 'w-24 px-2 py-1 border rounded'
                        }),
                        h('button', {
                          onClick: saveEditParticipant,
                          className: 'p-2 text-emerald-600 hover:bg-emerald-100 rounded'
                        }, h(Check, { size: 18 })),
                        h('button', {
                          onClick: () => setEditingParticipant(null),
                          className: 'p-2 text-slate-500 hover:bg-slate-100 rounded'
                        }, h(X, { size: 18 }))
                      )
                    : h('div', { key: p.id, className: 'flex items-center justify-between gap-2 p-3 bg-slate-50 rounded-lg' },
                        h('div', { className: 'flex flex-wrap items-center gap-2 sm:gap-4 min-w-0' },
                          h('span', { className: 'font-medium' }, p.name),
                          h('span', { className: 'px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-sm font-medium whitespace-nowrap' }, 'Quota: ', p.paQuota, ' PA')
                        ),
                        h('div', { className: 'flex items-center gap-1 flex-shrink-0' },
                          h('button', {
                            onClick: () => startEditParticipant(p),
                            className: 'p-2 text-emerald-500 hover:bg-emerald-50 rounded'
                          }, h(Pencil, { size: 18 })),
                          h('button', {
                            onClick: () => {
                              setParticipants(participants.filter((x) => x.id !== p.id));
                              const newPrefs = { ...preferences };
                              delete newPrefs[p.id];
                              setPreferences(newPrefs);
                            },
                            className: 'p-2 text-red-500 hover:bg-red-50 rounded'
                          }, h(Trash2, { size: 18 }))
                        )
                      )
                )
              )
        ),

        // Preferences Tab
        tab === 'preferences' && h('div', null,
          h('h2', { className: 'text-lg font-semibold mb-4' }, 'Set Preferences'),
          h('p', { className: 'text-slate-500 mb-4' }, 'Rate each shift: 0 stars = cannot do, 5 stars = would love to'),
          (shifts.length === 0 || participants.length === 0)
            ? h('p', { className: 'text-slate-500 text-center py-8' }, 'Add shifts and participants first')
            : h('div', { className: 'overflow-x-auto' },
                h('table', { className: 'w-full' },
                  h('thead', null,
                    h('tr', null,
                      h('th', { className: 'text-left p-2 border-b' }),
                      shifts.map((s) =>
                        h('th', { key: s.id, className: 'p-2 border-b text-sm font-medium text-slate-600' },
                          h('div', null, s.name),
                          h('div', { className: 'text-xs text-slate-400' }, s.date),
                          h('div', { className: 'text-xs text-indigo-500' }, s.pa, ' PA')
                        )
                      )
                    )
                  ),
                  h('tbody', null,
                    participants.map((p) =>
                      h('tr', { key: p.id },
                        h('td', { className: 'p-2 border-b' },
                          h('div', { className: 'font-medium' }, p.name),
                          h('div', { className: 'text-xs text-emerald-600' }, 'Quota: ', p.paQuota)
                        ),
                        shifts.map((s) =>
                          h('td', { key: s.id, className: 'p-2 border-b text-center' },
                            h(StarRating, {
                              value: preferences[p.id]?.[s.id] ?? 0,
                              onChange: (v) => updatePref(p.id, s.id, v)
                            })
                          )
                        )
                      )
                    )
                  )
                )
              ),
          shifts.length > 0 && participants.length > 0 &&
            h('button', {
              onClick: runOptimizer,
              className: 'mt-6 w-full py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium flex items-center justify-center gap-2'
            }, h(Zap, { size: 20 }), ' Optimize Schedule')
        ),

        // Results Tab
        tab === 'results' && h('div', null,
          h('h2', { className: 'text-lg font-semibold mb-4' }, 'Optimized Schedule'),
          !result
            ? h('p', { className: 'text-slate-500 text-center py-8' }, 'Run the optimizer to see results')
            : h('div', null,
                result.quotasNotMet && h('div', { className: 'mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg' },
                  h('span', { className: 'text-amber-800 font-medium' }, '⚠️ Could not satisfy all PA quotas. Showing best possible assignment.')
                ),
                h('div', { className: 'mb-4 p-4 bg-emerald-50 rounded-lg' },
                  h('span', { className: 'text-emerald-800 font-medium' }, `Total Satisfaction Score: ${result.score}`)
                ),
                h('h3', { className: 'font-medium text-slate-700 mb-2' }, 'PA Summary'),
                h('div', { className: 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-6' },
                  participants.map((p) => {
                    const assigned = result.paTotals[p.id] || 0;
                    const met = assigned >= p.paQuota;
                    return h('div', { key: p.id, className: `p-3 rounded-lg ${met ? 'bg-emerald-50' : 'bg-red-50'}` },
                      h('div', { className: 'font-medium' }, p.name),
                      h('div', { className: `text-sm ${met ? 'text-emerald-700' : 'text-red-700'}` },
                        assigned, ' / ', p.paQuota, ' PA ', met ? '✓' : '✗'
                      )
                    );
                  })
                ),
                h('h3', { className: 'font-medium text-slate-700 mb-2' }, 'Shift Assignments'),
                h('div', { className: 'space-y-2' },
                  shifts.map((s) => {
                    const assignedId = result.assignment[s.id];
                    const person = participants.find((p) => p.id === assignedId);
                    const pref = assignedId ? (preferences[assignedId]?.[s.id] ?? 0) : 0;
                    return h('div', { key: s.id, className: 'flex flex-wrap items-center justify-between gap-2 p-4 bg-slate-50 rounded-lg' },
                      h('div', { className: 'min-w-0' },
                        h('div', { className: 'font-medium' }, s.name),
                        h('div', { className: 'text-sm text-slate-500' }, s.date, s.time && ` at ${s.time}`, ' • ', s.pa, ' PA')
                      ),
                      h('div', { className: 'flex items-center gap-2 sm:gap-3' },
                        person
                          ? h(React.Fragment, null,
                              h('span', { className: 'font-medium text-indigo-600' }, person.name),
                              h('div', { className: 'flex' },
                                [1,2,3,4,5].map((star) =>
                                  h(Star, {
                                    key: star,
                                    size: 14,
                                    className: star <= pref ? 'fill-amber-400 text-amber-400' : 'text-gray-300'
                                  })
                                )
                              )
                            )
                          : h('span', { className: 'text-red-500 font-medium' }, 'Unassigned')
                      )
                    );
                  })
                )
              )
        )
      )
    )
  );
}

// Mount the app
const root = createRoot(document.getElementById('root'));
root.render(h(ShiftOptimizer));
    </script>
</body>
</html>
